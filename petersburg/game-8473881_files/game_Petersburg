function GetUsedCardPosition(){return 23}function GetCardStartIndex(){return board.status.charCodeAt(0)-48<3?29:8}function GetDoneForPhasePosition(){return board.status.charCodeAt(0)-48<3?146:7}function GetPlayerPosition(){return board.status.charCodeAt(0)-48<3?7:124}function GetGuildHallPosition(){return 124+4*GameInfo.NumPlayers}function GetNewSocietyStartIndex(){return GetGuildHallPosition()+1}function GetBanquetStartIndex(){return eval(GameInfo.Scenario&2)!=2?GetGuildHallPosition():GetNewSocietyStartIndex()+28}function CardType(n,t,i,r,u,f,e,o,s){this.id=n;this.imageName=t;this.cost=i;this.colour=r;this.income=u;this.points=f;this.baseColour=e;this.count=o;this.expansion=s}function Card(n,t,i){this.cardType=n;this.location=t;this.status_index=i;this.used=!1}function Player(){this.money=0;this.points=0;this.handcards=[];this.opencards=[];this.hiddenhandcards=[]}function GetVariantValue(){return GameInfo.Scenario}function CheckReplace(n){return n==newAcademyIndex||n==newMistressIndex||n==newCzarIndex||n==newMariinskiIndex||n==newObservatoryIndex}function Board(n){function t(n,t){this.status=this.status.substr(0,n)+t+this.status.substr(n+t.length)}function i(){var status_index;this.cards=[];this.newcards=[];this.oldcards=[];for(var counter=0,counter2=0,counter3=0,j,statusversion=board.status.charCodeAt(0)-48,i=0;i<CardTypes.length;i++){var replaceCards=eval(GetVariantValue()&8)==8,useBanquetExpansion=eval(GetVariantValue()&4)==4,useNewSocietyExpansion=eval(GetVariantValue()&2)==2,isBaseGameCard=CardTypes[i].expansion==0,isNewSocietyCard=CardTypes[i].expansion==1,id=CardTypes[i].id;if(isBaseGameCard&&(useNewSocietyExpansion||replaceCards)&&(id==academyIndex||id==czarIndex||id==observatoryIndex||id==mistressIndex||id==mariinskiIndex)){counter+=CardTypes[i].count;continue}if(isNewSocietyCard&&(!useNewSocietyExpansion&&(!replaceCards||!CheckReplace(id))||useBanquetExpansion&&id==debtorsPrisonIndex)){counter2+=CardTypes[i].count;continue}if(CardTypes[i].expansion==2&&!useBanquetExpansion){counter3+=CardTypes[i].count;continue}for(j=0;j<CardTypes[i].count;j++){isBaseGameCard?(status_index=GetCardStartIndex()+counter,counter++):isNewSocietyCard?id==newAcademyIndex?status_index=GetCardStartIndex()+academyPos:id==newCzarIndex?status_index=GetCardStartIndex()+czarPos:id==newObservatoryIndex?status_index=GetCardStartIndex()+observatoryPos+j:id==newMariinskiIndex?status_index=GetCardStartIndex()+mariinskiPos:id==newMistressIndex?status_index=GetCardStartIndex()+mistressPos+j:(status_index=GetNewSocietyStartIndex()+counter2,counter2++):(status_index=GetBanquetStartIndex()+counter3,counter3++);var owner=this.status.charCodeAt(status_index)-48,l=this.cards.length,card=new Card(i,owner,status_index);statusversion<3&&(id==observatoryIndex||id==pubIndex)&&(card.used=this.UsedStatus(l));owner==8?this.newcards.push(l):owner==7?this.oldcards.push(l):owner>=0&&owner<=3?this.players[owner].opencards.push(l):owner>=17&&owner<=20?this.players[owner-17].handcards.push(l):owner>=22&&owner<=25?(this.players[owner-22].handcards.push(l),this.players[owner-22].hiddenhandcards[this.players[owner-22].handcards.length-1]=!0):owner>=32&&owner<=35?(this.players[owner-32].handcards.push(l),this.players[owner-32].hiddenhandcards[this.players[owner-32].handcards.length-1]=!0):owner>=27&&owner<=30&&(this.players[owner-27].opencards.push(l),card.used=!0);this.cards.push(card)}}}function r(index){for(var flags=this.status.charCodeAt(GetUsedCardPosition())-65,mask=1,i=0;i<index;i++)(GetCardType(i).id==pubIndex||GetCardType(i).id==observatoryIndex)&&(mask=mask*2);return eval(flags&mask)==mask}function u(index){var flags=this.status.charCodeAt(GetDoneForPhasePosition())-65;return eval(flags&1<<index)==eval(1<<index)}function f(){for(var t,n=0;n<GameInfo.NumPlayers;n++)for(this.players.push(new Player),this.players[n].opencards=[],this.players[n].handcards=[],this.players[n].money=GetUserMoney(n),this.players[n].points=GetUserPoints(n),this.players[n].hiddenhandcards=[],t=0;t<4;t++)this.players[n].hiddenhandcards.push(!1)}this.status=n;this.players=[];this.newcards=[];this.oldcards=[];this.cards=[];this.players=[];this.UpdateStatus=t;this.ParseCards=i;this.InitPlayers=f;this.UsedStatus=r;this.PassedRound=u}function InitBoard(){var statusversion=board.status.charCodeAt(0)-48,i;for(statusversion==0&&(board.UpdateStatus(0,"2"),board.status=board.status+"0A"),statusversion==1&&(board.UpdateStatus(0,"2"),board.status=board.status+"A"),hiddenCards=eval(GetVariantValue()&1)==1,MovesDone="",finishTurnClicked=!1,playCardClicked=!1,replaceCardClicked=!1,takeOpenCardClicked=!1,buyPointsClicked=!1,setGuildHallClicked=!1,buyPoints2Clicked=!1,discardCard2Clicked=!1,observatoryCardClicked=!1,debtorsPrisonCardClicked=!1,buyObservatoryClicked=!1,discardCardClicked=!1,takeObservatoryClicked=!1,moveFinished=!1,UserIndex!=OnTurnIndex&&(IsActive="False"),IsHistory&&(LastMove="",SetHistoryMove()),board.InitPlayers(),board.ParseCards(),InitTabs(),ShowOpenCards(IsActive=="True"),ShowRound(),ShowLeftCards(),ShowStartMarkers(),ShowPlayerNames(),ShowPlayerMoney(),ShowPlayerPoints(),ShowLastMoves(),SetCardsOnHand(),i=0;i<GameInfo.NumPlayers;i++)ShowPlayerCards(i,IsActive=="True"&&i==OnTurnIndex);if(IsActive!="True"||IsHistory||CheckObservatory(),hiddenCards){for(i=0;i<4;i++)$("#imgHiddenCards"+i).hide();$("#imgDiscardCards").hide()}$("#PassHelp").mouseover(ShowPassHelp());RefreshHiddenCardsMouseover()}function ShowPassHelp(){return function(){return overlib(StrSPPassHelp,CAPTION,StrSPPassCaption,ABOVE,LEFT,DELAY,200,WIDTH,200,TIMEOUT,3e3)}}function SetCardsOnHand(){for(var n=0;n<GameInfo.NumPlayers;n++){var t=(n+UserIndex)%GameInfo.NumPlayers,i=document.getElementById("playerHand"+(n+1)),r=document.getElementById("playerHandText"+(n+1));PlayerOwnsCard(t,warehouseIndex)||board.players[t].handcards.length==4?(i.className="playerHand",r.className="playerHandText"):(i.className="playerHand3",r.className="playerHandText3")}}function CheckObservatory(){var i=board.status.charCodeAt(0)-48,n,t,r;if(i==3){for(n=9,t=0;t<board.cards.length;t++)if(board.cards[t].location==5){n=GetCardType(t).colour;break}}else n=board.status.charCodeAt(obsInUseIndex)-48;n!=9&&(i<3?(r=FindFirstUnusedObservatory(),ObservatoryCard(r,n)):ObservatoryCard(-1,n))}function FindFirstUnusedObservatory(){for(var t,i,n=0;n<board.players[OnTurnIndex].opencards.length;n++)if(t=board.players[OnTurnIndex].opencards[n],i=GetCardType(t),(i.id==observatoryIndex||i.id==newObservatoryIndex)&&!board.cards[t].used)return t;return-1}function ShowLastMoves(){var r,n,f,u,t,i;if(!IsHistory)for(r=0;r<GameInfo.NumPlayers;r++){for(f=-1,n=0;n<GameInfo.NumPlayers;n++)if(PlayerInfo[r].ID==LastMovesPID[n]){f=n;break}if(f!=-1&&(u=LastMovesStatus[f],typeof u!="undefined")){u==""&&(u="10,"+GetRound());u=="9"&&(u="10,"+(GetRound()+3)%4);t=u.split(",");n=(r-UserIndex+GameInfo.NumPlayers)%GameInfo.NumPlayers;switch(t[0]){case"1":ShowLastCard(n,t[1],!1);SetMoveText(n,StrBoughtCard);break;case"2":ShowLastCard(n,t[1],!1);SetMoveText(n,StrTookCard);break;case"3":ShowLastCard(n,t[1],!1);SetMoveText(n,StrPlayedCard);break;case"4":ShowLastCard(n,t[1],!1);t.length==3?SetMoveText(n,StrBoughtPoints+" ("+t[2]+")"):SetMoveText(n,StrBoughtPoints);break;case"5":ShowLastCard(n,t[2],t[1]=="2"&&PlayerInfo[r].ID!=UserID);i=StrUsedObservatory+" ";switch(t[1]){case"1":i+=StrBoughtCard;break;case"2":i+=StrTookCard;break;case"3":i+=StrDiscardedCard}SetMoveText(n,i);break;case"6":ShowLastCard(n,t[1],!1);i=StrUsedGuildHall+" "+t[2]+" "+StrPoints+" + "+(4-parseInt(t[2]))+" "+StrRubles;SetMoveText(n,i);break;case"7":ShowLastCard(n,t[2],t[1]=="2"&&PlayerInfo[r].ID!=UserID);i=StrUsedDebtorsPrison+" ";switch(t[1]){case"1":i+=StrBoughtCard;break;case"2":i+=StrTookCard;break;case"3":i+=StrDiscardedCard}SetMoveText(n,i);break;case"8":ShowLastCard(n,t[1],!1);SetMoveText(n,StrUsedTradingHouse);break;case"9":ShowLastCard(n,t[1],!1);SetMoveText(n,StrDiscardedCard);break;case"10":ShowLastRound(n,t[1]);SetMoveText(n,StrPassed)}}}}function ShowLastRound(n,t){var r=document.getElementById("lastcard"+(n+1)),i=document.createElement("img");i.src=GameImagePath+"s"+t+".gif";i.style.margin="40px 0px 0px 15px";r.innerHTML="";r.appendChild(i)}function ShowLastCard(n,t,i){var u=document.getElementById("lastcard"+(n+1)),r;r=i?GetHiddenImage(t):GetCardImage(t);r.className="openCard";u.innerHTML="";u.appendChild(r)}function SetMoveText(n,t){var i=document.getElementById("lastmovetext"+(n+1));i.innerHTML=t}function GetCardType(n){return CardTypes[board.cards[n].cardType]}function PlayCard(n,t,i){var r,u;if(!playCardClicked&&!moveFinished){if(playCardClicked=!0,nd(),r=GetCardType(n),r.colour==3){isNewCard=t;isHandCard=i;newCardType=r;newCardID=n;ShowOpenCards(!1);ShowPlayerCards(OnTurnIndex,!1,!0);return}if(u=DeterminePriceByCardType(r,!t&&!i),board.players[OnTurnIndex].money-=u,board.players[OnTurnIndex].money<0){CancelMove();return}board.players[OnTurnIndex].opencards.push(n);board.cards[n].location=OnTurnIndex;t?board.newcards=ArrayRemove(board.newcards,n):i?board.players[OnTurnIndex].handcards=ArrayRemove(board.players[OnTurnIndex].handcards,n):board.oldcards=ArrayRemove(board.oldcards,n);ShowOpenCards(!1);ShowPlayerCards(OnTurnIndex,!1,!1);ShowPlayerMoney();ShowPlayerPoints();MovesDone=i?"3,"+n:"1,"+n;RefreshHiddenCardsMouseover();moveFinished=!0}}function BuyPoints(n,t){buyPointsClicked||moveFinished||(buyPointsClicked=!0,nd(),board.players[OnTurnIndex].money-=2*t,board.players[OnTurnIndex].points+=t,board.cards[n].used=!0,board.status.charCodeAt(0)-48==3&&(board.cards[n].location=OnTurnIndex+27),ShowOpenCards(!1),ShowPlayerCards(OnTurnIndex,!1,!1),ShowPlayerMoney(),ShowPlayerPoints(),MovesDone="4,"+n+","+t,moveFinished=!0)}function SetGuildHall(n,t){setGuildHallClicked||moveFinished||(setGuildHallClicked=!0,nd(),board.UpdateStatus(GetGuildHallPosition(),String.fromCharCode(t+65)),board.cards[n].used=!0,board.status.charCodeAt(0)-48==3&&(board.cards[n].location=OnTurnIndex+27),MovesDone="6,"+n+","+t,ShowPlayerCards(UserIndex,!1,!1),moveFinished=!0)}function BuyPoints2(n){buyPoints2Clicked||moveFinished||(buyPoints2Clicked=!0,nd(),board.players[OnTurnIndex].money-=3,board.players[OnTurnIndex].points+=2,board.cards[n].used=!0,board.status.charCodeAt(0)-48==3&&(board.cards[n].location=OnTurnIndex+27),ShowOpenCards(!1),ShowPlayerCards(OnTurnIndex,!1,!1),ShowPlayerMoney(),ShowPlayerPoints(),MovesDone="8,"+n+",3",moveFinished=!0)}function TakeOpenCard(n,t){var i;takeOpenCardClicked||moveFinished||(takeOpenCardClicked=!0,nd(),board.players[OnTurnIndex].handcards.push(n),board.cards[n].location=OnTurnIndex+17,t?(board.newcards=ArrayRemove(board.newcards,n),i=$("#playerHand1").position(),$("#newcard"+n).css("z-index",3e3).animate({left:i.left+60*(board.players[UserIndex].handcards.length-1),top:i.top+292,height:96,width:60},600,function(){ShowOpenCards(!1);ShowPlayerCards(OnTurnIndex,!1,!1);ShowPlayerPoints()})):(board.oldcards=ArrayRemove(board.oldcards,n),i=$("#playerHand1").position(),$("#oldcard"+n).css("z-index",3e3).animate({left:i.left+60*(board.players[UserIndex].handcards.length-1),top:i.top+292,height:96,width:60},600,function(){ShowOpenCards(!1);ShowPlayerCards(OnTurnIndex,!1,!1);ShowPlayerPoints()})),MovesDone="2,"+n,RefreshHiddenCardsMouseover(),moveFinished=!0)}function ObservatoryCard(n,t){var i,u,f,r,e,o;if(!observatoryCardClicked&&!moveFinished){if(observatoryCardClicked=!0,nd(),ShowOpenCards(!1),ShowPlayerMoney(),ShowPlayerPoints(),u=board.status.charCodeAt(0)-48,u<3)f=board.status.charCodeAt(24+t)-48,i=GetRandomCardID(t,f);else{for(i=-1,r=0;r<board.cards.length;r++)if(board.cards[r].location==5){i=r;break}i<0&&(e=CountLeftCards(t),o=RandInt(0,e-1),i=GetRandomCardID(t,o))}board.cards[i].location=5;document.getElementById(BtnFinishTurnID).disabled=!0;document.getElementById(BtnCancelMoveID).disabled=!0;u<3?(board.UpdateStatus(obsInUseIndex,String.fromCharCode(t+48)),board.cards[n].used=!0):(board.UpdateStatus(board.cards[i].status_index,String.fromCharCode(53)),n>=0&&(board.cards[n].used=!0,board.cards[n].location=OnTurnIndex+27,board.UpdateStatus(board.cards[n].status_index,String.fromCharCode(48+OnTurnIndex+27))));ShowPlayerCards(OnTurnIndex,!1,!1);SetDBStatus()&&(ShowRandomCard(i),MovesDone="5,3,"+i)}}function DebtorsPrisonCard(n,t){debtorsPrisonCardClicked||moveFinished||(debtorsPrisonCardClicked=!0,HideDiscardPile(),ShowPlayerMoney(),ShowPlayerPoints(),board.cards[n].used=!0,board.status.charCodeAt(0)-48==3&&(board.cards[n].location=OnTurnIndex+27),board.cards[t].location=6,document.getElementById(BtnFinishTurnID).disabled=!0,ShowRandomCard(t),MovesDone="7,3,"+t)}function SetDBStatus(){return isGameValid?ServiceSetDBStatusSecure(GameInfo.ID,GameInfo.PlayerOnTurn,board.status,lastSaveStatus)?(lastSaveStatus=board.status,!0):(isGameValid=!1,alert(StrOutdatedStatusString),!1):!1}function BuyObservatory(n){var t,i;if(!buyObservatoryClicked&&!moveFinished){if(buyObservatoryClicked=!0,nd(),t=GetCardType(n),t.colour==3){isNewCard=!1;isHandCard=!1;isSpecial=!0;newCardType=t;newCardID=n;ShowOpenCards(!1);ShowPlayerCards(OnTurnIndex,!1,!0);return}HideRandomCard();document.getElementById(BtnFinishTurnID).disabled=!1;i=DeterminePriceByCardType(t,!1);board.players[OnTurnIndex].money-=i;board.players[OnTurnIndex].opencards.push(n);board.cards[n].location=OnTurnIndex;ShowPlayerCards(OnTurnIndex,!1,!1);ShowPlayerMoney();ShowPlayerPoints();MovesDone=debtorsPrisonCardClicked?"7,1,"+n:"5,1,"+n;moveFinished=!0}}function TakeObservatory(n){if(!takeObservatoryClicked&&!moveFinished){takeObservatoryClicked=!0;nd();moveFinished=!0;board.players[OnTurnIndex].handcards.push(n);document.getElementById(BtnFinishTurnID).disabled=!1;var t=$("#playerHand1").position(),i=$("#observatorycard").position();$("#observatoryCardImage").animate({left:t.left-i.left+5+60*(board.players[UserIndex].handcards.length-1),top:t.top-i.top+323,height:96,width:60},600,function(){ShowPlayerCards(OnTurnIndex,!1,!1);HideRandomCard();ShowLeftCards();ShowPlayerPoints()});debtorsPrisonCardClicked?(MovesDone="7,2,"+n,board.cards[n].location=OnTurnIndex+32):(MovesDone="5,2,"+n,board.cards[n].location=OnTurnIndex+22)}}function HideRandomCard(){for(var n=document.getElementById("observatorycard"),t;n.hasChildNodes();)t=n.firstChild,n.removeChild(t);n.innerHTML=""}function ShowRandomCard(n){var i=document.getElementById("observatorycard"),t;i.innerHTML="";t=GetCardImage(n);t.setAttribute("id","observatoryCardImage");t.onmouseover=BuildObservatory2Context(n);t.style.position="absolute";i.appendChild(t)}function ReplaceCard(n){if(!replaceCardClicked&&!moveFinished){replaceCardClicked=!0;var t=GetCardType(n),i=GetReplacementPrice(t,newCardType,!isNewCard&&!isHandCard&&!isSpecial);if(board.players[OnTurnIndex].money-=i,board.players[OnTurnIndex].money<0){CancelMove();return}document.getElementById(BtnFinishTurnID).disabled=!1;board.cards[newCardID].location=OnTurnIndex;board.players[OnTurnIndex].opencards.push(newCardID);isHandCard?(board.players[OnTurnIndex].handcards=ArrayRemove(board.players[OnTurnIndex].handcards,newCardID),MovesDone="3,"+newCardID):isNewCard?(board.newcards=ArrayRemove(board.newcards,newCardID),MovesDone="1,"+newCardID):isSpecial?(HideRandomCard(),ShowLeftCards(),MovesDone=debtorsPrisonCardClicked?"7,1,"+newCardID:"5,1,"+newCardID):(board.oldcards=ArrayRemove(board.oldcards,newCardID),MovesDone="1,"+newCardID);board.cards[n].location=6;board.players[OnTurnIndex].opencards=ArrayRemove(board.players[OnTurnIndex].opencards,n);ShowOpenCards(!1);ShowPlayerCards(OnTurnIndex,!1,!1);ShowPlayerMoney();ShowPlayerPoints();RefreshHiddenCardsMouseover();moveFinished=!0}}function PlayerOwnsCard(n,t){for(var r,i=0;i<board.players[n].opencards.length;i++)if(r=GetCardType(board.players[n].opencards[i]),r.id==t)return!0;return!1}function GetRound(){return board.status.charCodeAt(2)-48}function DiscardPileSize(){for(var t=0,n=0;n<board.cards.length;n++)board.cards[n].location==6&&t++;return t}function ShowPlayerCards(n,t,i){var v=(n-UserIndex+GameInfo.NumPlayers)%GameInfo.NumPlayers,s=document.getElementById("playerOpenCards"+(v+1)),u,r,e,y,o,f,c,p,l,a;for(s.innerHTML="",y=!1,o=[[],[],[]],r=0;r<board.players[n].opencards.length;r++)f=board.players[n].opencards[r],e=GetCardType(f),o[e.colour==3?e.baseColour:e.colour].push(f);for(board.players[n].opencards=o[0],r=0;r<o[1].length;r++)board.players[n].opencards.push(o[1][r]);for(r=0;r<o[2].length;r++)board.players[n].opencards.push(o[2][r]);for(r=0;r<board.players[n].opencards.length;r++)f=board.players[n].opencards[r],e=GetCardType(f),u=GetCardImage(f),u.className="playerCard",t&&e.id==pubIndex&&GetRound()==1&&!board.cards[f].used&&(u.onmouseover=BuildPubContext(f)),t&&e.id==tradingHouseIndex&&GetRound()==1&&!board.cards[f].used&&(u.onmouseover=BuildTradingHouseContext(f)),t&&e.id==sycophantIndex&&GetRound()==2&&(u.onmouseover=BuildSycophantContext(n,f),u.setAttribute("id","specialcard"+f)),t&&e.id==guildHallIndex&&GetRound()==1&&!board.cards[f].used&&(u.onmouseover=BuildGuildHallContext(f)),t&&(e.id==observatoryIndex||e.id==newObservatoryIndex)&&GetRound()==1&&!board.cards[f].used&&(u.onmouseover=BuildObservatoryContext(f)),t&&e.id==debtorsPrisonIndex&&GetRound()==1&&!board.cards[f].used&&DiscardPileSize()>0&&(u.onmouseover=BuildDebtorsPrisonContext(f)),board.cards[f].used&&(c=e.imageName,UserLang==1&&(c="en/"+c),u.src=GameImagePath+c+"o.jpg"),board.players[n].opencards.length>38?(u.style.width="45px",u.style.height="72px"):board.players[n].opencards.length>32&&(u.style.width="50px",u.style.height="80px"),p=!1,i&&(document.getElementById(BtnFinishTurnID).disabled=!0,!board.cards[f].used&&MayReplace(e,newCardType)&&(l=GetReplacementPrice(e,newCardType,!isHandCard&&!isNewCard&&!isSpecial),l<=board.players[OnTurnIndex].money&&(u.style.border="solid 2px red",p=!0,a=document.createElement("a"),a.href="javascript:ReplaceCard("+board.players[OnTurnIndex].opencards[r]+");",a.appendChild(u),s.appendChild(a)))),p||(e.id==guildHallIndex&&(y=!0,u.id="card"),s.appendChild(u));if(y){var h=board.status.charCodeAt(GetGuildHallPosition())-65,w=$("#card"),l=w.position(),b=w.width(),k;for(k=b==60?20:b==50?16:14,h>4?h=4:h<0&&(h=0),u=$("<img>").attr("id","stripe").attr("src",GameImagePath+"kombistreifen_"+(4-h)+"rubel_"+h+"sp.jpg").css("position","absolute").css("width",b-4+"px").css("height",k+"px").css("left",2+l.left+"px").css("top",l.top+w.height()-k-2+"px"),r=0;r<board.cards.length;r++)if(e=GetCardType(r),e.id==guildHallIndex){f=r;break}t&&GetRound()==1&&!board.cards[f].used&&u.mouseover(BuildGuildHallContext());$("#playerOpenCards"+(v+1)).append(u)}for(s=document.getElementById("playerHand"+(v+1)),s.innerHTML="",r=0;r<board.players[n].handcards.length;r++)(board.players[n].hiddenhandcards[r]||hiddenCards)&&PlayerInfo[n].ID!=UserID&&!IsHistory?(u=GetHiddenImage(board.players[n].handcards[r]),u.style.width="60px",u.style.height="100px",u.setAttribute("id","handcard"+r)):u=GetCardImage(board.players[n].handcards[r]),u.className="playerHandCard",t&&(u.onmouseover=BuildContextMenu(board.players[n].handcards[r],!0,!1)),s.appendChild(u)}function ShowOpenCards(n){var u=document.getElementById("newcards"),i,r,t;for(u.innerHTML="",r=3,i=0;i<board.newcards.length;i++)t=GetCardImage(board.newcards[i]),t.style.position="absolute",t.style.top="5px",t.style.left=r+"px",t.setAttribute("id","newcard"+board.newcards[i]),r=r+81,n&&(t.onmouseover=BuildContextMenu(board.newcards[i],!1,!0)),u.appendChild(t);for(u=document.getElementById("oldcards"),u.innerHTML="",r=3+(8-board.oldcards.length)*81,i=0;i<board.oldcards.length;i++)t=GetCardImage(board.oldcards[i]),t.style.position="absolute",t.style.top="135px",t.style.left=r+"px",t.setAttribute("id","oldcard"+board.oldcards[i]),r=r+81,n&&(t.onmouseover=BuildContextMenu(board.oldcards[i],!1,!1)),u.appendChild(t)}function GetMinPrice(n,t){for(var r=1e4,u,f,i=0;i<board.players[OnTurnIndex].opencards.length;i++)u=GetCardType(board.players[OnTurnIndex].opencards[i]),!board.cards[board.players[OnTurnIndex].opencards[i]].used&&MayReplace(u,n)&&(f=GetReplacementPrice(u,n,t),f<r&&(r=f));return r}function GetReplacementPrice(n,t,i){var u=DeterminePriceByCardType(t,i),r=u-n.cost;return n.id==potemkinIndex&&(r-=4),r<1&&(r=1),r}function DeterminePriceByCardType(n,t){var i=n.cost,r;for(t&&i--,r=0;r<board.players[OnTurnIndex].opencards.length;r++)n.imageName==GetCardType(board.players[OnTurnIndex].opencards[r]).imageName&&i--;return PlayerOwnsCard(OnTurnIndex,communeIndex)&&(n.colour==0||n.colour==3&&n.baseColour==0)&&i--,PlayerOwnsCard(OnTurnIndex,24)&&(n.colour==1||n.colour==3&&n.baseColour==1)&&i--,PlayerOwnsCard(OnTurnIndex,25)&&(n.colour==2||n.colour==3&&n.baseColour==2)&&i--,i<1&&(i=1),i}function MayReplace(n,t){return t.baseColour==n.colour?n.colour==0?t.id==revolutionIndex?!0:n.id==czarIndex||n.id==newCzarIndex?!0:t.id-n.id==24||t.id==69&&n.id==4?!0:!1:!0:!1}function BuildContextMenu(n,t,i){var o=GetCardType(n),h=DeterminePriceByCardType(o,!t&&!i),u=!1,s="",f,c,e,r;return o.colour==3?(f=GetMinPrice(o,!t&&!i),u=EnoughMoney(f),s=f!=1e4?"min. "+f:"???"):(u=EnoughMoney(h),s=h),c=FreeHand(),e=200,!t&&c?e=230:u||(e=100),r="<div style='background-color:#b6cbe1;padding:5px 5px 5px 5px;width:"+e+"px;'>",r+="<p><b>"+StrCost+": "+s+"<\/b><\/p><p>",t?u&&(r+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:PlayCard("+n+", false, true)'>"+StrPlayCard+"<\/a><br/>"):(u&&(r+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:PlayCard("+n+","+i+", false)'>"+StrBuyCard+"<\/a><br/>"),FreeHand()&&(r+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:TakeOpenCard("+n+","+i+")'>"+StrTakeHandCard+"<\/a><br/>")),r+="<\/p><\/div>",function(){return overlib(r,FULLHTML,FOLLOWMOUSE,MOUSEOFF,NOCLOSE,OFFSETX,5,OFFSETY,5,RIGHT,ABOVE,DELAY,200,TIMEOUT,3e3)}}function BuildPubContext(n){var i="<div style='background-color:#b6cbe1;;padding:5px 5px 5px 5px;width:200px;'><p>",u,r,t;for(i+="<p><b>"+StrBuyPoints+": <\/b><\/p><p>",u=board.players[OnTurnIndex].money,r=(u-u%2)/2,r>5&&(r=5),t=1;t<=r;t++)i+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:BuyPoints("+n+","+t+")'>"+t*2+" "+StrRubles+" --> "+t+" "+StrPoints+"<\/a><br/>";return i+="<\/p><\/div>",function(){return overlib(i,FULLHTML,FOLLOWMOUSE,MOUSEOFF,NOCLOSE,OFFSETX,5,OFFSETY,5,RIGHT,ABOVE,DELAY,200,TIMEOUT,3e3)}}function BuildGuildHallContext(n){var i="<div style='background-color:#b6cbe1;;padding:5px 5px 5px 5px;width:200px;'><p>",t;for(i+="<p><b>"+StrGuildHallSelection+": <\/b><\/p><p>",t=0;t<=4;t++)i+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:SetGuildHall("+n+","+t+")'>"+t+" "+StrPoints+" / "+(4-t)+" "+StrRubles+"<\/a><br/>";return i+="<\/p><\/div>",function(){return overlib(i,FULLHTML,FOLLOWMOUSE,MOUSEOFF,NOCLOSE,OFFSETX,5,OFFSETY,5,RIGHT,ABOVE,DELAY,200,TIMEOUT,3e3)}}function BuildTradingHouseContext(n){var t="<div style='background-color:#b6cbe1;;padding:5px 5px 5px 5px;width:200px;'><p>",i;return t+="<p><b>"+StrBuyPoints+": <\/b><\/p><p>",i=board.players[OnTurnIndex].money,i>=3&&(t+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:BuyPoints2("+n+")'>3 "+StrRubles+" --> 2 "+StrPoints+"<\/a><br/>"),t+="<\/p><\/div>",function(){return overlib(t,FULLHTML,FOLLOWMOUSE,MOUSEOFF,NOCLOSE,OFFSETX,5,OFFSETY,5,RIGHT,ABOVE,DELAY,200,TIMEOUT,3e3)}}function BuildSycophantContext(n,t){var i="<div style='background-color:#b6cbe1;;padding:5px 5px 5px 5px;width:200px;'><p>";return i+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:DiscardCard2("+n+","+t+")'>"+StrDiscardCard+"<\/a><br/>",i+="<\/p><\/div>",function(){return overlib(i,FULLHTML,FOLLOWMOUSE,MOUSEOFF,NOCLOSE,OFFSETX,5,OFFSETY,5,RIGHT,ABOVE,DELAY,200,TIMEOUT,3e3)}}function BuildObservatoryContext(n){var i="<div style='background-color:#b6cbe1;;padding:5px 5px 5px 5px;width:170px;'><p>",t;for(i+="<p><b>"+StrUseObservatory+": <\/b><\/p><p>",t=0;t<4;t++)CountLeftCards(t)<2||(i+="<a class='contextlink' href='javascript:ObservatoryCard("+n+","+t+")'><img src='"+GameImagePath+"s"+t+".gif' width='30px' height='30px'><\/a>&nbsp;");return i+="<\/p><\/div>",function(){return overlib(i,FULLHTML,FOLLOWMOUSE,MOUSEOFF,NOCLOSE,OFFSETX,5,OFFSETY,5,RIGHT,ABOVE,DELAY,200,TIMEOUT,3e3)}}function BuildDebtorsPrisonContext(n){var t="<div style='background-color:#b6cbe1;;padding:5px 5px 5px 5px;width:170px;'><p>";return t+="<p><b>"+StrUseDebtorsPrison+": <\/b><\/p><p>",t+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:ShowDiscardPile("+n+")'>"+StrShowDiscardPile+"<\/a><br/>",t+="<\/p><\/div>",function(){return overlib(t,FULLHTML,FOLLOWMOUSE,MOUSEOFF,NOCLOSE,OFFSETX,5,OFFSETY,5,RIGHT,ABOVE,DELAY,200,TIMEOUT,3e3)}}function HideDiscardPile(){return $("#DiscardPileContainer.ui-draggable").draggable("disable").hide(),showDiscardPileClicked=!1,!1}function ShowDiscardPile(n){var s,h,o,f,e,r,u,t,i,c;if(!showDiscardPileClicked){for(s=document.getElementById("DiscardPileContainer"),s.innerHTML="",showDiscardPileClicked=!0,nd(),h=$("<h3>").css("text-align","center").html(n>=0?StrUseDebtorsPrison:StrDiscardPile),$("#DiscardPileContainer").show().append(h),o=$("<div>").attr("id","slider"),f=$("<ul>"),o.append(f),r="",u=0,t=0;t<board.cards.length;t++)(board.cards[t].location==6||n<0&&board.cards[t].location>=32&&board.cards[t].location<37&&board.cards[t].location-32!=UserIndex)&&(i=GameImagePath,UserLang==1&&(i=i+"en/"),i=i+GetCardType(t).imageName+".jpg",r+=n>=0?"<a href='javascript:DebtorsPrisonCard("+n+","+t+")'><img src='"+i+"' style='padding:5px 5px 5px'><\/a>":"<img src='"+i+"' style='padding:5px 5px 5px'>",u++,u==6&&(e=$("<li>").html(r).css("width","520px").css("height","130px"),f.append(e),r="",u=0));u>0&&(e=$("<li>").html(r).css("width","520px").css("height","130px"),f.append(e));$("#DiscardPileContainer").append(o);$("#DiscardPileContainer").draggable({distance:30});$("#slider").easySlider({nextText:"",prevText:""});n<0?(c=$("<button>").html(StrSPClose).click(function(){return HideDiscardPile()}),$("#DiscardPileContainer").append(c)):(ShowOpenCards(!1),ShowPlayerCards(OnTurnIndex,!1,!1))}}function BuildObservatory2Context(n){var r=GetCardType(n),e=DeterminePriceByCardType(r,!1),u=!1,f="",i,t;return r.colour==3?(i=GetMinPrice(r,!1),u=EnoughMoney(i),f=i!=1e4?"min. "+i:"???"):(u=EnoughMoney(e),f=e),t="<div style='background-color:#b6cbe1;;padding:5px 5px 5px 5px;width:230px;'><p>",t+="<p><b>"+StrCost+": "+f+"<\/b><\/p><p>",u&&(t+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:BuyObservatory("+n+")'>"+StrBuyCard+"<\/a><br/>"),FreeHand()&&(t+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:TakeObservatory("+n+","+isNewCard+")'>"+StrTakeHandCard+"<\/a><br/>"),t+="<img src='"+BaseImagePath+"c/link.gif'> <a class='contextlink' href='javascript:DiscardCard("+n+")'>"+StrDiscardCard+"<\/a><br/>",t+="<\/p><\/div>",function(){return overlib(t,FULLHTML,FOLLOWMOUSE,MOUSEOFF,NOCLOSE,OFFSETX,5,OFFSETY,5,RIGHT,ABOVE,DELAY,200,TIMEOUT,3e3)}}function EnoughMoney(n){return board.players[OnTurnIndex].money>=n}function FreeHand(){var n=3;return PlayerOwnsCard(OnTurnIndex,warehouseIndex)&&n++,n-board.players[OnTurnIndex].handcards.length>0}function ShowPlayerMoney(){for(var t,i,n=0;n<GameInfo.NumPlayers;n++)t=(n-UserIndex+GameInfo.NumPlayers)%GameInfo.NumPlayers,i=document.getElementById("rubel"+(t+1)),i.innerHTML=!hiddenCards||PlayerInfo[n].ID==UserID||IsHistory?board.players[n].money+" "+StrRubles:""}function CalculatePointsForNobles(playerIndex){for(var nobs=[],k,ct,found,cnt,add,points,j=0;j<board.players[playerIndex].opencards.length;j++)if(ct=GetCardType(board.players[playerIndex].opencards[j]),ct.colour==2||ct.colour==3&&ct.baseColour==2){for(found=!1,k=0;k<nobs.length;k++)if(nobs[k]==ct.imageName){found=!0;break}found||nobs.push(ct.imageName)}return cnt=nobs.length,add=0,cnt>10&&(add=cnt-10,cnt=10),points=(cnt+1)*cnt/2,eval(GetVariantValue()&2)==2&&(points+=add*10),points}function CalculateAdditionalPointsByCategory(n){var t=[];return t.push(CalculatePointsForNobles(n)),t.push(Math.floor(board.players[n].money/10)),t.push(-(board.players[n].handcards.length*5)),t}function ShowPlayerPoints(){for(var t,n=0;n<GameInfo.NumPlayers;n++){var r=(n-UserIndex+GameInfo.NumPlayers)%GameInfo.NumPlayers,i=document.getElementById("points"+(r+1)),u=CalculateAdditionalPointsByCategory(n);function f(n,t){var i='<table style="background-color:#b6cbe1"><tbody><tr><td>'+StrPoints+'<\/td><td align="right">'+n+"<td/><\/tr>";return i+="<tr><td>"+StrPoints+" "+StrFor+" "+StrAristocrats+'<\/td><td align="right">'+t[0]+"<\/td><\/tr>",GetVariantValue()%2==0&&(i+="<tr><td>"+StrPoints+" "+StrFor+" "+StrRubles+'<\/td><td align="right">'+t[1]+"<\/td><\/tr>"),i+="<tr><td>"+StrPoints+" "+StrFor+" "+StrHandcards+'<\/td><td align="right">'+t[2]+"<\/td><\/tr>",i+="<\/tbody><\/table>",function(){return overlib(i,FULLHTML,FOLLOWMOUSE,LEFT,BELOW,DELAY,200)}}i.innerHTML=board.players[n].points+" "+StrPoints;board.status.charCodeAt(1)-48!=1&&(t="player_points_"+n,i.innerHTML+=" <img src='"+BaseImagePath+"c/help.png' id='"+t+"' />",$("#"+t).mouseover(f(board.players[n].points,u)),$("#"+t).mouseout(function(){nd()}))}}function ShowPlayerNames(){for(var t,i,n=0;n<GameInfo.NumPlayers;n++)t=(n-UserIndex+GameInfo.NumPlayers)%GameInfo.NumPlayers,i=document.getElementById("playerInfo"+(t+1)),i.style.display="inline",FormatPlayerName("playerName"+(t+1),n,!1,!0)}function ShowStartMarkers(){for(var i,r,t,n=0;n<4;n++)i=document.getElementById("startingStones"+(n+1)),i.innerHTML="";for(n=0;n<4;n++)r=board.status.charCodeAt(3+n)-48,r=(r-UserIndex+GameInfo.NumPlayers)%GameInfo.NumPlayers,i=document.getElementById("startingStones"+(r+1)),t=document.createElement("img"),t.src=GameImagePath+"s"+n+".gif",t.style.height="30px",t.style.width="30px",t.style.marginRight="10px",i.appendChild(t)}function ShowRound(){var i=document.getElementById("currentRound"),r,t,n;if(i.style.backgroundImage="url("+GameImagePath+"s"+board.status.substr(2,1)+".gif)",!IsHistory&&OnTurnIndex==UserIndex){for(r=-1,t=0;t<GameInfo.NumPlayers;t++)if(PlayerInfo[OnTurnIndex].ID==LastMovesPID[t]){r=t;break}(n=LastMovesStatus[r],typeof n!="undefined")&&n!=""&&(n=="9"||n.substr(0,2)=="10"&&n.charCodeAt(3)-48!=GetRound())&&(i.innerHTML=StrNewPhase,i.style.backgroundColor="black")}}function RefreshHiddenCardsMouseover(){var n;if($("#discardPileSize").html(DiscardPileSize()),!hiddenCards){for(n=0;n<4;n++)$("#imgHiddenCards"+n).mouseover(HiddenCardsMouseover(n)).mouseout(function(){nd()});DiscardPileSize()>0&&$("#imgDiscardCards").mouseover(function(){return ShowDiscardPile(-1)})}}function ShowLeftCards(){for(var t,n=0;n<4;n++)t=document.getElementById("leftcardtext"+n),t.innerHTML=CountLeftCards(n)}function CountLeftCards(n){for(var i=0,t=0;t<board.cards.length;t++)board.cards[t].location==9&&CardTypes[board.cards[t].cardType].colour==n&&i++;return i}function InitTabs(){for(var i,t,n=0;n<GameInfo.NumPlayers;n++)i=(n-UserIndex+GameInfo.NumPlayers)%GameInfo.NumPlayers,t=document.getElementById("cardTab"+(i+1)),t.style.display="inline",t.innerHTML=StrCardsOf+" "+PlayerInfo[n].Login;SelectTab(1)}function SubmitForm(){var n,t,i,r;if(!IsHistory){if(!isGameValid){alert(StrOutdatedStatusString);return}n=document.getElementsByName("MoveInfo")[0];n.setAttribute("value",MovesDone);t=document.getElementsByName("NewStatus")[0];t.setAttribute("value",board.status);i=document.getElementById("frmGame");r=document.getElementById("divPostback");r.style.display="";i.submit()}}function SetUserPoints(n,t){var i=t%25,r=(t-i)/25;board.UpdateStatus(GetPlayerPosition()+4*n,String.fromCharCode(65+r));board.UpdateStatus(GetPlayerPosition()+1+4*n,String.fromCharCode(65+i))}function GetUserPoints(n){return(board.status.charCodeAt(GetPlayerPosition()+4*n)-65)*25+board.status.charCodeAt(GetPlayerPosition()+1+4*n)-65}function SetUserMoney(n,t){var i=t%25,r=(t-i)/25;board.UpdateStatus(GetPlayerPosition()+2+4*n,String.fromCharCode(65+r));board.UpdateStatus(GetPlayerPosition()+3+4*n,String.fromCharCode(65+i))}function GetUserMoney(n){return(board.status.charCodeAt(GetPlayerPosition()+2+4*n)-65)*25+board.status.charCodeAt(GetPlayerPosition()+3+4*n)-65}function SetHistoryMove(){moveNr==0?(board.status=StartStatus,MovesDone=""):(board.status=HistoryStatus[moveNr-1],MovesDone=HistoryMove[moveNr-1])}function HandleResize(){var n=GetWindowWidth(),t=GetWindowHeight();SaveSize(n,t);FormatFooter()}function SelectTab(n){for(var r,u,i,t=1;t<5;t++)if(r=document.getElementById("playerCards"+t),u=document.getElementById("cardTab"+t),t==n){if(r.style.display="inline",u.className="cardSelectorTabSelected",i=$("#card"),i.length){var i=$("#card"),o=i.position(),f=i.width(),e;e=f==60?20:f==50?16:14;img=$("#stripe").css("left",o.left+2+"px").css("top",o.top+i.height()-e-2+"px").css("width",f-4+"px").css("height",e+"px")}}else r.style.display="none",u.className="cardSelectorTab";currentTab=n}function HighlightTab(n){if(n!=currentTab){var t=document.getElementById("cardTab"+n);t.className="cardSelectorTabHover"}}function LowlightTab(n){if(n!=currentTab){var t=document.getElementById("cardTab"+n);t.className="cardSelectorTab"}}function CancelMove(){cancelMoveClicked||finishTurnClicked||(cancelMoveClicked=!0,HideRandomCard(),board=new Board(OrigStatus),isNewCard=!1,newCardType=null,newCardID=-1,isHandCard=!1,isSpecial=!1,InitBoard(),HideDiscardPile(),document.getElementById(BtnFinishTurnID).disabled=!1,cancelMoveClicked=!1)}function SaveCards(){for(var n=0;n<board.cards.length;n++)board.UpdateStatus(board.cards[n].status_index,String.fromCharCode(board.cards[n].location+48))}function DiscardCard(n){discardCardClicked||moveFinished||(discardCardClicked=!0,nd(),board.cards[n].location=6,$("#observatoryCardImage").animate({left:"+=35",top:"+=165",height:80,width:50,opacity:.5},600,function(){HideRandomCard()}),document.getElementById(BtnFinishTurnID).disabled=!1,RefreshHiddenCardsMouseover(),moveFinished=!0)}function HiddenCardsMouseover(colour){var owner,imageName;if(IsHistory)return!1;for(var scontent="<div style='padding:0px 0px 0px;width:645px;",content="'>",cnt=0,cnt2=0,srcName,lastImageName="",doHide=eval(GetVariantValue()&1)==1,i=0;i<board.cards.length;i++)if(owner=board.cards[i].location,GetCardType(i).colour==colour&&(!(owner>=5)||!(owner<9))&&!(owner>=32)){var doInclude=!1,playerId=-1,isHidden=!1;owner==9?doInclude=!0:owner<5?playerId=owner:owner<22?(playerId=owner-17,isHidden=doHide):owner<27?(playerId=owner-22,isHidden=!0):playerId=owner-27;playerId!=UserIndex&&isHidden&&(doInclude=!0);doInclude&&(imageName=GetCardType(i).imageName,cnt>0&&imageName!=lastImageName?(srcName=GameImagePath,UserLang==1&&(srcName=srcName+"en/"),srcName=srcName+lastImageName+".jpg",content+="<div style='position:absolute;top:"+(Math.floor(cnt2/8)*125+25)+"px;left:"+(cnt2%8*80+5)+"px;width:80px;'>",content+="<img src='"+srcName+"' style='position:absolute;top:0px;left:0px;width=75px;height=120px;'>",cnt>1?(content+="<img src='"+srcName+"' style='position:absolute;top:3px;left:3px;width=75px;height=120px;'>",content+="<div style='position:absolute;top:110px;left:70px;'><b>"+cnt+"<\/b><\/div>"):content+="<\/div>",content+="<\/div>",lastImageName=imageName,cnt=1,cnt2++):(cnt++,cnt==1&&(lastImageName=imageName)))}return cnt>0&&(srcName=GameImagePath,UserLang==1&&(srcName=srcName+"en/"),srcName=srcName+lastImageName+".jpg",content+="<div style='position:absolute;top:"+(Math.floor(cnt2/8)*125+25)+"px;left:"+(cnt2%8*80+5)+"px;width:80px;'>",content+="<img src='"+srcName+"' style='position:absolute;top:0px;left:0px;width=75px;height=120px;'>",cnt>1?(content+="<img src='"+srcName+"' style='position:absolute;top:3px;left:3px;width=75px;height=120px;'>",content+="<div style='position:absolute;top:110px;left:70px;'><b>"+cnt+"<\/b><\/div>"):content+="<\/div>",content+="<\/div>",scontent+="height:"+(Math.floor(cnt2/8)*125+130)+"px;"),content=scontent+content+"<\/div>",function(){return overlib(content,CAPTION,StrHiddenCardsCaption,WIDTH,645,FIXX,5,FIXY,5,FOLLOWMOUSE,DELAY,500)}}function DiscardCard2(n,t){discardCard2Clicked||moveFinished||(discardCard2Clicked=!0,nd(),board.players[n].opencards=ArrayRemove(board.players[n].opencards,t),board.cards[t].location=6,ShowOpenCards(!1),ShowPlayerCards(OnTurnIndex,!1,!1),RefreshHiddenCardsMouseover(),MovesDone="9,"+t,moveFinished=!0)}function FinishMove(){var t,i,n;if(!finishTurnClicked&&!cancelMoveClicked){for(finishTurnClicked=!0,HideRandomCard(),MovesDone==""&&SavePassedFlag(),t=CheckRoundSwitch(),t&&(board.UpdateStatus(GetDoneForPhasePosition(),"A"),CheckGameEnd()),ShowPlayerMoney(),ShowPlayerPoints(),i=board.status.charCodeAt(0)-48,i<3&&DetermineNewRandomCards(),SaveUsedFlag(t),SaveCards(),n=0;n<GameInfo.NumPlayers;n++)SetUserPoints(n,board.players[n].points),SetUserMoney(n,board.players[n].money);i<3&&board.UpdateStatus(obsInUseIndex,String.fromCharCode(57));firsti>=0?($("#oldcard"+firsti).animate({opacity:0},600,function(){SubmitForm()}),firsti=-1):SubmitForm()}}function DetermineNewRandomCards(){for(var t,i,n=0;n<4;n++)(t=CountLeftCards(n),t!=0)&&(i=RandInt(0,t-1),board.UpdateStatus(24+n,String.fromCharCode(i+48)))}function GetRandomCardID(n,t){for(var r=0,i=0;i<board.cards.length;i++)if(board.cards[i].location==9&&GetCardType(i).colour==n){if(r==t)return i;r++}return-1}function RandInt(n,t){for(var r=t-n+1,u=Math.random(),i=0;i<=r-1;i++)if(u>=i/r&&u<(i+1)/r)return i+n}function SavePassedFlag(){var n=board.status.charCodeAt(GetDoneForPhasePosition())-65;document.getElementById("cbxEndPhase").checked&&(n=n|1<<OnTurnIndex);board.UpdateStatus(GetDoneForPhasePosition(),String.fromCharCode(n+65))}function SaveUsedFlag(n){var f=board.status.charCodeAt(0)-48,t,r,i,u;if(n){if(f<3)board.UpdateStatus(GetUsedCardPosition(),"A");else for(t=0;t<board.cards.length;t++)board.cards[t].location>=27&&board.cards[t].location<=30&&(board.cards[t].location-=27);return}if(f<3){for(r=0,i=1,t=0;t<board.cards.length;t++)u=GetCardType(t).id,(u==observatoryIndex||u==pubIndex)&&(board.cards[t].used&&(r+=i),i=i*2);board.UpdateStatus(GetUsedCardPosition(),String.fromCharCode(r+65))}}function CheckGameEnd(){var i,n,r,t;if(board.status.charCodeAt(2)-48==0){for(i=!1,n=0;n<4;n++)if(CountLeftCards(n)==0){i=!0;break}if(i){for(n=0;n<GameInfo.NumPlayers;n++){for(r=CalculateAdditionalPointsByCategory(n),t=0;t<r.length;t++)board.players[n].points+=r[t];board.players[n].points<0&&(board.players[n].points=0);board.players[n].money=board.players[n].money%10}board.UpdateStatus(1,"1")}}}function CheckFastSwitch(){if(board.newcards.length>0||board.oldcards.length>0||GetRound()==1)return!1;for(var n=0;n<GameInfo.NumPlayers;n++)if(board.players[n].handcards.length>0)return!1;return!0}function GetPlayerIndex(n){for(var t=0;t<GameInfo.NumPlayers;t++)if(PlayerInfo[t].ID==n)return t}function CheckRoundSwitch(){var e=CheckFastSwitch(),n,r,t,u,i,f;if(e)MovesDone==""&&(MovesDone="10,"+GetRound());else{if(MovesDone!=""&&!board.PassedRound(OnTurnIndex))return!1;for(MovesDone="10,"+GetRound(),n=0;n<GameInfo.NumPlayers;n++)if(LastMovesPID[n]!=PlayerInfo[OnTurnIndex].ID&&(r=GetPlayerIndex(LastMovesPID[n]),LastMovesStatus[n]!=MovesDone&&!board.PassedRound(r)))return!1}if(t=board.status.charCodeAt(2)-48,u=(t+1)%4,t<3)AwardPointsAndMoney(t);else if(t==3){for(firsti=-1,n=0;n<board.cards.length;n++)board.cards[n].location==7&&(firsti<0&&(firsti=n),board.cards[n].location=6,$("#oldcard"+n).css("z-index",3e3-n).animate({left:722,top:205,height:80,width:50},{duration:600,queue:!1})),board.cards[n].location==8&&(board.cards[n].location=7);for(board.oldcards=board.newcards,board.newcards=[],n=3;n<7;n++)i=board.status.charCodeAt(n)-48,i=(i+1)%GameInfo.NumPlayers,board.UpdateStatus(n,String.fromCharCode(i+48))}return f=document.getElementsByName("newround")[0],f.setAttribute("value","1"),board.UpdateStatus(2,String.fromCharCode(u+48)),!0}function AwardPointsAndMoney(n){for(var r,i,u,t=0;t<GameInfo.NumPlayers;t++){for(r=0;r<board.players[t].opencards.length;r++)i=GetCardType(board.players[t].opencards[r]),i.id==sycophantIndex||i.colour!=n&&(i.colour!=3||i.baseColour!=n)||board.cards[board.players[t].opencards[r]].used||(board.players[t].money+=i.income,board.players[t].points+=i.points),n==1&&((i.colour==2||i.colour==3&&i.baseColour==2)&&((PlayerOwnsCard(t,mariinskiIndex)||PlayerOwnsCard(t,coffeeHouseIndex))&&board.players[t].money++,PlayerOwnsCard(t,newMariinskiIndex)&&board.players[t].points++),PlayerOwnsCard(t,textileFactoryIndex)&&(i.id==2||i.id==26||i.id==revolutionIndex||i.id==newCzarIndex)&&(board.players[t].points+=2),i.id==guildHallIndex&&(u=board.status.charCodeAt(GetGuildHallPosition())-65,board.players[t].points+=u,board.players[t].money+=4-u)),n==2&&(PlayerOwnsCard(t,taxmanIndex)&&(i.colour==0||i.colour==3&&i.baseColour==0)&&board.players[t].money++,PlayerOwnsCard(t,mayorIndex)&&(i.colour==1||i.colour==3&&i.baseColour==1)&&board.players[t].money++);for(r=board.players[t].opencards.length-1;r>=0;r--)i=GetCardType(board.players[t].opencards[r]),i.id==sycophantIndex&&n==2&&(board.players[t].money==0?(board.cards[board.players[t].opencards[r]].location=6,board.players[t].opencards=ArrayRemove(board.players[t].opencards,board.players[t].opencards[r]),ShowOpenCards(!1),ShowPlayerCards(OnTurnIndex,!1,!1),RefreshHiddenCardsMouseover()):board.players[t].money--)}}function ArrayRemove(n,t){for(var r=[],i=0;i<n.length;i++)n[i]!=t&&r.push(n[i]);return r}function UserGiveUp(){CancelMove();board.UpdateStatus(1,"2");SubmitForm()}function GetCardImage(n){var t=GetCardType(n).imageName,i=document.createElement("img");return i.src=UserLang==1?GameImagePath+"en/"+t+".jpg":GameImagePath+t+".jpg",i}function GetHiddenImage(n){var t,i;switch(GetCardType(n).colour){case 0:t="w00";break;case 1:t="b00";break;case 2:t="a00";break;case 3:t="t00"}return i=document.createElement("img"),i.style.width="75px",i.style.height="120px",i.src=GameImagePath+t+".gif",i}var currentTab,cancelMoveClicked,firsti;(function(n){n.fn.easySlider=function(t){var t=n.extend({prevId:"prevBtn",prevText:"Previous",nextId:"nextBtn",nextText:"Next",controlsShow:!0,controlsBefore:"",controlsAfter:"",controlsFade:!0,firstId:"firstBtn",firstText:"First",firstShow:!1,lastId:"lastBtn",lastText:"Last",lastShow:!1,vertical:!1,speed:800,auto:!1,pause:2e3,continuous:!1,numeric:!1,numericId:"controls"},t);this.each(function(){function v(i){i=parseInt(i)+1;n("li","#"+t.numericId).removeClass("current");n("li#"+t.numericId+i).addClass("current")}function y(){i>f&&(i=0);i<0&&(i=f);t.vertical?n("ul",r).css("margin-left",i*c*-1):n("ul",r).css("margin-left",i*o*-1);l=!0;t.numeric&&v(i)}function e(u,s){var h,v,w;if(l){l=!1;h=i;switch(u){case"next":i=h>=f?t.continuous?i+1:f:i+1;break;case"prev":i=i<=0?t.continuous?i-1:0:i-1;break;case"first":i=0;break;case"last":i=f;break;default:i=u}v=Math.abs(h-i);w=v*t.speed;t.vertical?(p=i*c*-1,n("ul",r).animate({marginTop:p},{queue:!1,duration:w,complete:y})):(p=i*o*-1,n("ul",r).animate({marginLeft:p},{queue:!1,duration:w,complete:y}));!t.continuous&&t.controlsFade&&(i==f?(n("a","#"+t.nextId).hide(),n("a","#"+t.lastId).hide()):(n("a","#"+t.nextId).show(),n("a","#"+t.lastId).show()),i==0?(n("a","#"+t.prevId).hide(),n("a","#"+t.firstId).hide()):(n("a","#"+t.prevId).show(),n("a","#"+t.firstId).show()));s&&clearTimeout(a);t.auto&&u=="next"&&!s&&(a=setTimeout(function(){e("next",!1)},v*t.speed+t.pause))}}var r=n(this),h=n("li",r).length,o=n("li",r).width(),c=n("li",r).height(),l=!0,f,i,u,s,a;if(r.width(o),r.height(c),r.css("overflow","hidden"),f=h-1,i=0,n("ul",r).css("width",h*o),t.continuous&&(n("ul",r).prepend(n("ul li:last-child",r).clone().css("margin-left","-"+o+"px")),n("ul",r).append(n("ul li:nth-child(2)",r).clone()),n("ul",r).css("width",(h+1)*o)),t.vertical||n("li",r).css("float","left"),t.controlsShow&&(u=t.controlsBefore,t.numeric?u+='<ol id="'+t.numericId+'"><\/ol>':(t.firstShow&&(u+='<span id="'+t.firstId+'"><a href="javascript:void(0);">'+t.firstText+"<\/a><\/span>"),u+=' <span id="'+t.prevId+'"><a href="javascript:void(0);">'+t.prevText+"<\/a><\/span>",u+=' <span id="'+t.nextId+'"><a href="javascript:void(0);">'+t.nextText+"<\/a><\/span>",t.lastShow&&(u+=' <span id="'+t.lastId+'"><a href="javascript:void(0);">'+t.lastText+"<\/a><\/span>")),u+=t.controlsAfter,n(r).after(u)),t.numeric)for(s=0;s<h;s++)n(document.createElement("li")).attr("id",t.numericId+(s+1)).html("<a rel="+s+' href="javascript:void(0);">'+(s+1)+"<\/a>").appendTo(n("#"+t.numericId)).click(function(){e(n("a",n(this)).attr("rel"),!0)});else n("a","#"+t.nextId).click(function(){e("next",!0)}),n("a","#"+t.prevId).click(function(){e("prev",!0)}),n("a","#"+t.firstId).click(function(){e("first",!0)}),n("a","#"+t.lastId).click(function(){e("last",!0)});t.auto&&(a=setTimeout(function(){e("next",!1)},t.pause));t.numeric&&v(0);!t.continuous&&t.controlsFade&&(n("a","#"+t.prevId).hide(),n("a","#"+t.firstId).hide())})}})(jQuery);var obsInUseIndex=28,hiddenCards=!1,moveFinished=!1,finishTurnClicked=!1,playCardClicked=!1,buyPointsClicked=!1,setGuildHallClicked=!1,buyPoints2Clicked=!1,takeOpenCardClicked=!1,replaceCardClicked=!1,showDiscardPileClicked=!1,discardCard2Clicked=!1,observatoryCardClicked=!1,debtorsPrisonCardClicked=!1,buyObservatoryClicked=!1,discardCardClicked=!1,takeObservatoryClicked=!1;var isNewCard=!1,newCardType=null,newCardID=-1,isHandCard=!1,isSpecial=!1,lastSaveStatus=OrigStatus,isGameValid=!0;var CardTypes=[new CardType(50,"53",3,0,2,0,0,1,1),new CardType(0,"1",3,0,3,0,0,6,0),new CardType(1,"2",4,0,3,0,0,6,0),new CardType(2,"3",5,0,3,0,0,6,0),new CardType(3,"4",6,0,3,0,0,6,0),new CardType(4,"5",7,0,3,0,0,6,0),new CardType(5,"6",8,0,3,0,0,1,0),new CardType(49,"52",9,0,3,1,0,6,1),new CardType(6,"10",5,1,0,1,0,5,0),new CardType(7,"12",8,1,0,2,0,5,0),new CardType(8,"13",11,1,0,3,0,3,0),new CardType(53,"13",11,1,0,3,0,2,1),new CardType(9,"14",14,1,0,4,0,3,0),new CardType(54,"14",14,1,0,4,0,1,1),new CardType(10,"15",17,1,0,5,0,3,0),new CardType(11,"16",20,1,0,6,0,2,0),new CardType(12,"17",23,1,0,7,0,1,0),new CardType(56,"57",25,1,0,9,0,1,1),new CardType(13,"9",2,1,0,0,0,1,0),new CardType(57,"58",2,1,0,0,0,1,1),new CardType(14,"7",1,1,0,0,0,2,0),new CardType(15,"8",2,1,0,0,0,1,0),new CardType(16,"11",6,1,0,1,0,2,0),new CardType(51,"54",6,1,0,0,0,1,1),new CardType(55,"56",8,1,0,1,0,2,1),new CardType(52,"55",8,1,0,1,0,1,1),new CardType(58,"59",1,2,-1,0,0,2,1),new CardType(17,"18",4,2,1,0,0,6,0),new CardType(18,"19",7,2,2,0,0,5,0),new CardType(59,"19",7,2,2,0,0,1,1),new CardType(19,"20",10,2,3,0,0,5,0),new CardType(60,"20",10,2,3,0,0,1,1),new CardType(20,"21",12,2,4,0,0,4,0),new CardType(61,"21",12,2,4,0,0,1,1),new CardType(21,"22",14,2,4,1,0,3,0),new CardType(62,"22",14,2,4,1,0,1,1),new CardType(22,"23",16,2,5,2,0,2,0),new CardType(63,"23",16,2,5,2,0,1,1),new CardType(23,"24",18,2,6,3,0,2,0),new CardType(64,"60",18,2,3,4,0,2,1),new CardType(24,"25",4,3,3,0,0,1,0),new CardType(25,"26",6,3,3,0,0,1,0),new CardType(26,"27",8,3,6,0,0,2,0),new CardType(27,"28",10,3,3,2,0,3,0),new CardType(28,"29",12,3,6,1,0,3,0),new CardType(69,"29",12,3,6,1,0,1,1),new CardType(73,"61",13,3,3,2,0,1,1),new CardType(70,"67",15,3,6,2,0,1,1),new CardType(29,"30",10,3,0,0,1,1,0),new CardType(30,"31",13,3,5,1,1,1,0),new CardType(67,"68",13,3,0,0,1,1,1),new CardType(31,"32",14,3,4,2,1,1,0),new CardType(32,"33",15,3,3,3,1,1,0),new CardType(33,"34",16,3,2,4,1,1,0),new CardType(68,"69",16,3,0,0,1,1,1),new CardType(34,"35",16,3,5,2,1,1,0),new CardType(35,"36",17,3,1,5,1,1,0),new CardType(36,"37",17,3,4,3,1,1,0),new CardType(37,"38",18,3,3,4,1,1,0),new CardType(65,"62",18,3,0,6,1,1,1),new CardType(38,"39",19,3,2,5,1,1,0),new CardType(66,"63",20,3,0,0,1,1,1),new CardType(39,"40",6,3,1,1,2,1,0),new CardType(71,"64",6,3,3,0,2,1,1),new CardType(40,"41",8,3,0,2,2,1,0),new CardType(41,"42",8,3,4,0,2,1,0),new CardType(42,"43",10,3,5,0,2,1,0),new CardType(43,"44",12,3,2,2,2,1,0),new CardType(72,"65",12,3,0,3,2,1,1),new CardType(74,"66",13,3,0,0,2,1,1),new CardType(44,"45",16,3,0,4,2,1,0),new CardType(45,"46",17,3,0,0,2,1,0),new CardType(46,"47",18,3,3,3,2,1,0),new CardType(47,"48",20,3,2,4,2,1,0),new CardType(48,"49",24,3,0,6,2,1,0)],potemkinIndex=13,pubIndex=14,warehouseIndex=15,taxmanIndex=45,academyIndex=12,academyPos=52,czarIndex=5,czarPos=30,observatoryIndex=16,observatoryPos=57,mistressIndex=23,mistressPos=84,mariinskiIndex=29,mariinskiPos=96,newMistressIndex=64,newAcademyIndex=56,debtorsPrisonIndex=52,newObservatoryIndex=55,newMariinskiIndex=66,newCzarIndex=50,communeIndex=73,sycophantIndex=58,guildHallIndex=67,textileFactoryIndex=68,mayorIndex=74,tradingHouseIndex=57,coffeeHouseIndex=51,revolutionIndex=70;window.onresize=HandleResize;currentTab=0;cancelMoveClicked=!1;firsti=-1